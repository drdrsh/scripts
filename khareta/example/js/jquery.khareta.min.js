/*! jQuery.Khareta v1.0.0 | (c) 2014 Mostafa Abdelraouf | http://www.opensource.org/licenses/mit-license.php */
(function(e,t,n,r){function u(t,n){this.element=t;this.settings=e.extend({},o,n);this._defaults=o;this._name=s;this.init()}var i={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(e){var t="";var n,r,s,o,u,a,f;var l=0;e=i._utf8_encode(e);while(l<e.length){n=e.charCodeAt(l++);r=e.charCodeAt(l++);s=e.charCodeAt(l++);o=n>>2;u=(n&3)<<4|r>>4;a=(r&15)<<2|s>>6;f=s&63;if(isNaN(r)){a=f=64}else if(isNaN(s)){f=64}t=t+this._keyStr.charAt(o)+this._keyStr.charAt(u)+this._keyStr.charAt(a)+this._keyStr.charAt(f)}return t},decode:function(e){var t="";var n,r,s;var o,u,a,f;var l=0;e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");while(l<e.length){o=this._keyStr.indexOf(e.charAt(l++));u=this._keyStr.indexOf(e.charAt(l++));a=this._keyStr.indexOf(e.charAt(l++));f=this._keyStr.indexOf(e.charAt(l++));n=o<<2|u>>4;r=(u&15)<<4|a>>2;s=(a&3)<<6|f;t=t+String.fromCharCode(n);if(a!=64){t=t+String.fromCharCode(r)}if(f!=64){t=t+String.fromCharCode(s)}}t=i._utf8_decode(t);return t},_utf8_encode:function(e){e=e.replace(/\r\n/g,"\n");var t="";for(var n=0;n<e.length;n++){var r=e.charCodeAt(n);if(r<128){t+=String.fromCharCode(r)}else if(r>127&&r<2048){t+=String.fromCharCode(r>>6|192);t+=String.fromCharCode(r&63|128)}else{t+=String.fromCharCode(r>>12|224);t+=String.fromCharCode(r>>6&63|128);t+=String.fromCharCode(r&63|128)}}return t},_utf8_decode:function(e){var t="";var n=0;var r=c1=c2=0;while(n<e.length){r=e.charCodeAt(n);if(r<128){t+=String.fromCharCode(r);n++}else if(r>191&&r<224){c2=e.charCodeAt(n+1);t+=String.fromCharCode((r&31)<<6|c2&63);n+=2}else{c2=e.charCodeAt(n+1);c3=e.charCodeAt(n+2);t+=String.fromCharCode((r&15)<<12|(c2&63)<<6|c3&63);n+=3}}return t}};var s="khareta",o={strFullscreen:"Full screen",strPoints:"Points",strPolyline:"Polyline",strPolygon:"Polygon",mapTypeId:google.maps.MapTypeId.TERRAIN,strokeColor:"#FF0000",fillColor:"#5555FF",strokeOpacity:1,fillOpacity:1,strokeWeight:3,initialZoom:4,initialCenter:new google.maps.LatLng(33.358062,9.755859),initialMode:"polygon",maxCount:0,codec:"json"};e.extend(u.prototype,{VERSION:"1.0.0",mDomInput:null,mDomParent:null,mMapObject:null,mDomMap:null,mDomFscrBtn:null,mDomMode:null,mMarkers:[],mPath:null,mMode:"",mMapElement:null,mIsReady:false,mIsFullscreen:false,init:function(){var t=this;if(this.mIsReady){return}this.mDomInput=e(this.element);this.mDomInput.hide();this.mDomMap=e("<div />").addClass(s+"-inline-map map-"+this.mDomInput.attr("id")).attr("id",this.generateRandomId());this.mDomInput.after(this.mDomMap);this.mMapObject=new google.maps.Map(n.getElementById(this.mDomMap.attr("id")),{zoom:this.settings.initialZoom,center:this.settings.initialCenter,mapTypeId:this.settings.mapTypeId,mapTypeControl:false,scaleControl:false,rotateControl:false,panControl:false,streetViewControl:false,overviewMapControl:false,zoomControl:true,zoomControlOptions:{style:google.maps.ZoomControlStyle.LARGE}});this.mPath=new google.maps.MVCArray;this.mDomFscrBtn=n.createElement("div");e(this.mDomFscrBtn).addClass(s+"-btn-fullscreen").html(this.settings.strFullscreen).click(function(){t.toggleFullscreen.call(t,!t.mIsFullscreen)});this.mDomFscrBtn.index=1;var r=n.createElement("div");this.mDomMode=e("<select />").addClass(s).append(e("<option />").attr("value","point").html(this.settings.strPoints)).append(e("<option />").attr("value","polyline").html(this.settings.strPolyline)).append(e("<option />").attr("value","polygon").html(this.settings.strPolygon)).on("change."+s,function(){t.onModeSelectChanged.apply(t)});e(r).append(this.mDomMode);this.mMapObject.controls[google.maps.ControlPosition.TOP_RIGHT].push(this.mDomFscrBtn);this.mMapObject.controls[google.maps.ControlPosition.BOTTOM_LEFT].push(r);google.maps.event.addListener(this.mMapObject,"click",function(e){t.onMapClicked.call(t,e)});this.readInputElement();this.turnOnListeners();var i=this.mPath.getArray();if(i.length>0){bounds=new google.maps.LatLngBounds;for(idx in i){bounds.extend(i[idx])}this.mMapObject.fitBounds(bounds)}},getIndexWithinPath:function(e){for(var t=0;t<this.mPath.getLength();t++){var n=this.mPath.getAt(t);if(n.lat()==e.lat()&&n.lng()==e.lng()){return t}}return-1},getData:function(){var e=[];var t=this.mPath.getArray();for(idx in t){e.push([t[idx].lat(),t[idx].lng()])}return{mode:this.mMode,points:e}},serialize:function(){return this.encode(this.getData())},unserialize:function(e){this.turnOffListeners();var t={};try{t=this.decode(e)}catch(n){this.turnOnListeners();return false}this.clear();this.setMode(t.mode);for(idx in t.points){this.addPoint(new google.maps.LatLng(t.points[idx][0],t.points[idx][1]),-1)}this.turnOnListeners();return true},turnOffListeners:function(){this.mDomInput.off("change."+s)},turnOnListeners:function(){var e=this;this.mDomInput.on("change."+s,function(){e.readInputElement()})},readInputElement:function(){if(!this.unserialize(this.mDomInput.val())){this.setMode(this.settings.initialMode)}},writeInputElement:function(){this.mDomInput.val(this.serialize())},toggleFullscreen:function(t){var r=this;if(t){e("body").addClass(s+"-body-no-scroll");this.mDomMap.addClass("fullscreen");e(n).on("keyup."+s,function(e){if(e.keyCode==27){r.toggleFullscreen(false)}})}else{e("body").removeClass(s+"-body-no-scroll");this.mDomMap.removeClass("fullscreen");e(n).off("keyup."+s)}this.mIsFullscreen=t;google.maps.event.trigger(this.mMapObject,"resize")},clear:function(){if(this.mMapElement){this.mMapElement.setMap(null);this.mMapElement=null}this.mPath.clear();for(var e=0;e<this.mMarkers.length;e++){this.mMarkers[e].setMap(null)}this.mMarkers=[]},generateRandomId:function(){function e(){return Math.floor((1+Math.random())*65536).toString(16).substring(1)}return e()+e()+e()+e()},encode:function(e){var t=this.settings.codec.toLowerCase();switch(t){case"base64":return i.encode(JSON.stringify(e));default:case"json":return JSON.stringify(e)}},decode:function(e){var t=this.settings.codec.toLowerCase();switch(t){case"base64":return JSON.parse(i.decode(e));default:case"json":return JSON.parse(e)}},addPoint:function(e,t){var n=this;if(this.mMode==""){return}if(this.settings.maxCount!=0&&this.settings.maxCount<=this.mPath.getLength()){return}if(t==-1){this.mPath.push(e)}else{this.mPath.insertAt(t,e)}var r=new google.maps.Marker({position:e,map:this.mMapObject,title:"#"+this.mPath.length,draggable:true});google.maps.event.addListener(r,"click",function(e){n.onMarkerClicked.call(n,e,this)});google.maps.event.addListener(r,"dragstart",function(e){n.onMarkerDragStart.call(n,e,this)});google.maps.event.addListener(r,"dragend",function(e){n.onMarkerDragEnd.call(n,e,this)});this.mMarkers.push(r);this.writeInputElement()},onMarkerClicked:function(e,t){t.setMap(null);for(var n=0,r=this.mMarkers.length;n<r&&this.mMarkers[n]!=t;++n);this.mPath.removeAt(this.getIndexWithinPath(t.position));this.mMarkers.splice(n,1);this.writeInputElement()},onMarkerDragStart:function(e,t){t.originalLatLng=e.latLng},onMarkerDragEnd:function(e,t){if(t.originalLatLng==null)return;this.mPath.setAt(this.getIndexWithinPath(t.originalLatLng),e.latLng);t.originalLatLng=null;this.writeInputElement()},onMapClicked:function(e){var t=e.latLng;var n=99999;var r=-1;if(this.mMode=="polygon"){for(var i=0;i<this.mPath.getLength();i++){var s=parseInt(this.getDistanceBetweenPoints(t,this.mPath.getAt(i)),10);if(n>s){r=i;n=s}}}this.addPoint(t,r)},getDistanceBetweenPoints:function(e,t){rad=function(e){return e*Math.PI/180};distHaversine=function(e,t){var n=6371;var r=rad(t.lat()-e.lat());var i=rad(t.lng()-e.lng());var s=Math.sin(r/2)*Math.sin(r/2)+Math.cos(rad(e.lat()))*Math.cos(rad(t.lat()))*Math.sin(i/2)*Math.sin(i/2);var o=2*Math.atan2(Math.sqrt(s),Math.sqrt(1-s));var u=n*o;return u.toFixed(3)};return distHaversine(e,t)},onModeSelectChanged:function(){var e=this.mDomMode.val();if(this.mMapElement){this.mMapElement.setMap(null);this.mMapElement=null}switch(e){case"point":this.mMode=e;break;case"polyline":this.mMode=e;this.mMapElement=new google.maps.Polyline({path:this.mPath,strokeColor:this.settings.strokeColor,strokeOpacity:this.settings.strokeOpacity,strokeWeight:this.settings.strokeWeight});this.mMapElement.setMap(this.mMapObject);break;case"polygon":this.mMode=e;this.mMapElement=new google.maps.Polygon({strokeWeight:this.settings.strokeWeight,strokeColor:this.settings.strokeColor,strokeOpacity:this.settings.strokeOpacity,fillColor:this.settings.fillColor,fillOpacity:this.settings.fillOpacity});this.mMapElement.setMap(this.mMapObject);this.mMapElement.setPaths(new google.maps.MVCArray([this.mPath]));break}this.writeInputElement()},setMode:function(e){var e=(""+e).toLowerCase();switch(e){case"point":case"polyline":case"polygon":break;default:e="point"}this.mDomMode.val(e);this.mDomMode.change()}});var a={toggleFullscreen:function(e){this.toggleFullscreen(e)},setMode:function(e){this.setMode(e)},getData:function(){return this.getData()}};e.fn[s]=function(t){var n=arguments;if(typeof a[t]=="function"){var r=this.get(0);var i=e.data(r,"plugin_"+s);return a[t].apply(i,Array.prototype.slice.call(n,1))}else if(typeof t==="object"||!t){this.each(function(){if(this.tagName!="TEXTAREA"){e.error(s+" only works with textareas!");return}if(!e.data(this,"plugin_"+s)){e.data(this,"plugin_"+s,new u(this,t))}})}else{e.error("Method "+t+" does not exist on jQuery."+s)}return this}})(jQuery,window,document)